- name: Add my user
  ansible.builtin.user:
    name: matteomarchiori
    create_home: true
    group: sudo
    password: $6$Bup0lmjBItHs$Gik6fvCh/n3IMcmvt5iV1Dp4fl4itegO9s48HfIAcYMDsmCrAhQUYyU5tlXcEX2Ws1STn4J/.Qu8lPoNlDLLA0
    update_password: always
    shell: /bin/bash
    state: present
#
#- name: Add authorized_key
#  authorized_key:
#    user: matteomarchiori
#    state: present
#    key: "https://github.com/matteomarchiori.keys"
#    validate_certs: false
#
#- name: Disable root login over SSH
#  lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
#  notify:
#    - restart sshd
#
#- name: Disable password login
#  lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
#  notify:
#    - restart sshd

- name: Install basic packages
  package:
    name: "{{ item }}"
    state: present
  loop:
    - net-tools
    - mosh
    - nginx

- name: Install node (last stable version)
  community.general.snap:
    name:
      - node
    classic: yes  

- name: Clone battleship
  ansible.builtin.git:
    repo: https://github.com/ivoputzer/awesome-devops-and-cd-ed4.git
    dest: /home/matteomarchiori/battleship
    version: master

- name: Change file ownership, group and permissions
  command: sudo chown -R vagrant:vagrant battleship
  args:
    chdir: /home/matteomarchiori    

#- name: Install packages based on package.json.
#  community.general.npm:
#    path: /home/matteomarchiori/battleship

- name: Install packages based on package.json.
  command: npm install
  args:
    chdir: /home/matteomarchiori/battleship

- name: Install pm2
  command: sudo npm install pm2 -g


- name: Run battleship parcel
  command: pm2 --name BattleShip start npm -- dev
  args:
    chdir: /home/matteomarchiori/battleship

- name: Run battleship server.js
  command: pm2 --name Websocket start npm -- start
  args:
    chdir: /home/matteomarchiori/battleship    


#- name: delete default nginx site
#  file:
#    path: /etc/nginx/sites-enabled/default
#    state: absent
#  notify: restart nginx
#
#- name: copy nginx proxy configuration
#  template:
#    src: battleshipproxy
#    dest: /etc/nginx/sites-enabled/battleshipproxy
#    owner: root
#    group: root
#    mode: '0644'
#  notify: restart nginx